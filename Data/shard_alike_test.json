[
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    jax.random.normal(jax.random.key(0), 1000)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jax.jit, abstracted_axes=(None, 'n'))\ndef f(x):\n    return x[0]"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef g():\n    return jnp.zeros(n) + x"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    y = x + 2\n    return (jnp.nan, y)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    x, y = jax.lax.cond(x < 3, lambda x, y: (x * 2, y), lambda x, y: (x * 3, y), x, y)\n    return (x, y)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def g():\n    return jax.lax.cond(True, lambda: data[0], lambda: data[1])"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    return 0.0 / x"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f():\n    weird_dict = {lambda x: x: 2.0, lambda x: x * 2: 3}\n    weirder_dict = {lambda x: x: weird_dict}\n    x = 2.0\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')\n    del weirder_dict\n    return x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef g():\n    debugger.breakpoint(stdin=stdin, stdout=stdout, backend='cli')"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x):\n    out = jnp.zeros_like(x)\n\n    def body(i, j, k, refs):\n        x_ref, out_ref = refs\n        y = func(x_ref[i, j, k])\n        out_ref[i, j, k] += y\n    return for_loop.for_loop(x.shape, body, (x, out))[1].sum()"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def g(a, b):\n    c = jnp.zeros_like(a)\n    _, b, c, _ = for_impl(5, body2, (a, b, c, 0))\n    return (b, c)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(a, b, c, d, e):\n    return (a, b, c, d, e)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x):\n    return jsp.special.betainc(jnp.ones(3), 1.0, x)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    return jnp.add(3.0, 4.0)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(x, y):\n    z = jax_getattr(thing1, 'x')\n    w = jax_getattr(thing2, 'x')\n    out = jnp.sin(x * y * z * w)\n    jax_setattr(thing1, 'x', out)\n    jax_setattr(thing2, 'x', 2 * out)\n    return (3 * out, 4 * out)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef g():\n    _, _, attr_tangents = attrs.jvp(f, (), (), [(thing, 'x', 1.0)])\n    (thing_, attr_, tangent_), = attr_tangents\n    self.assertIs(thing, thing_)\n    self.assertEqual(attr_, 'x')\n    return (jax_getattr(thing, 'x'), tangent_)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.vmap\n@jax.value_and_grad\n@jax.named_scope('foo')\ndef f(x):\n\n    @jax.named_scope('scan_body')\n    def body(carry, x):\n        return (carry * x, carry + x)\n    return lax.scan(body, x, jnp.arange(8.0))[0]"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@pjit\ndef g(y):\n    return jnp.sin(y)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f():\n    out = [rng(shape, dtype or jnp.float_) for shape, dtype in zip(shapes, dtypes)]\n    if np_arrays:\n        return out\n    return [jnp.asarray(a) if isinstance(a, (np.ndarray, np.generic)) else a for a in out]"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(c, a):\n    tracer_spy.append(c)\n    d = 0.75\n    b = jnp.sin(c * jnp.sum(jnp.cos(d * a)))\n    c = 0.9 * jnp.cos(d * jnp.sum(jnp.sin(c * a)))\n    return (c, b)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.remat\ndef g(x):\n    jax.jit(lambda: 0 if jnp.add(1, 1) else 0)()\n    return lax.sin(x)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "def f(pred):\n\n    def true_fun():\n        x_ref[()] = 1.0\n\n    def false_fun():\n        x_ref[()] = 2.0\n    jax.lax.cond(pred, true_fun, false_fun)"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@functools.partial(pjit.pjit, in_shardings=jax.sharding.PartitionSpec(None), out_shardings=jax.sharding.PartitionSpec('x'))\ndef f():\n    return jnp.zeros([32, 10])"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef f(x, r):\n    x = x.at[:, 0].set(x[:, 0] / r)\n    return x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.jit\ndef g(x):\n    if x > 0.0:\n        return x * 2\n    else:\n        return x + 2"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@partial(jnp.vectorize, excluded={1})\ndef f(x, y):\n    assert x.ndim == 0\n    assert y == 'foo'\n    return x"
  },
  {
    "test_code": "def test_basic(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * x\n        z = y * 2\n        _, z = shard_alike(x, z)\n        return z * 2\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * np_inp * 4)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_output_sharded_alike_input(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp * 2)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_arange_shard_alike_jit(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertEqual(out.sharding, s)\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_different_shapes(self):\n    mesh = jtu.create_mesh((2, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        return shard_alike(x, y)[1]\n    with self.assertRaisesRegex(ValueError, 'The leaves shapes of `x` and `y` should match'):\n        f(inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_double_shard_alike(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n        y = x * 2\n        _, y = shard_alike(x, y)\n        z = y @ y.T\n        a = jnp.arange(64).reshape(8, 8)\n        return shard_alike(z, a)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, NamedSharding(mesh, P('x')))\n    self.assertEqual(out2.sharding, NamedSharding(mesh, P('x')))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_shard_like_eager(self):\n    mesh = jtu.create_mesh((4, 1), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def f(x):\n        y = jnp.arange(16).reshape(8, 2)\n        return shard_alike(x, y)[1]\n    out = f(inp)\n    self.assertTrue(out.sharding.is_equivalent_to(s, out.ndim))\n    self.assertArraysEqual(out, np_inp)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_shard_map(self):\n    mesh = jtu.create_mesh((4, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp = jax.device_put(np_inp, s)\n\n    def g(x):\n        return jax.lax.psum(x, 'x')\n\n    @jax.jit\n    def f(x):\n        y = x @ x.T\n        s_out = shard_map(g, mesh, in_specs=P('x', 'y'), out_specs=P(None, 'y'))(y)\n        z = s_out.T @ s_out\n        return shard_alike(y, z)\n    out1, out2 = f(inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_shard_alike_inputs(self):\n    mesh = jtu.create_mesh((2,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n    arr = jax.device_put(np_inp, s)\n\n    def f(x, y):\n        return shard_alike(x, y)\n    eager_out1, eager_out2 = f(arr, np_inp)\n    self.assertEqual(eager_out1.sharding, s)\n    self.assertEqual(eager_out2.sharding, s)\n    out1, out2 = jax.jit(f)(arr, np_inp)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_vmap_one_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(2)\n    s = NamedSharding(mesh, P('y'))\n    inp = jax.device_put(np_inp, s)\n\n    @jax.jit\n    def f(x):\n\n        def _shard_slice_like_arg(s):\n            sharded_s, _ = shard_alike(s, x)\n            return sharded_s\n        replicated_x = jnp.tile(x, [8, 1])\n        return jax.vmap(_shard_slice_like_arg, in_axes=0)(replicated_x)\n    out = f(inp)\n    self.assertEqual(out.sharding, NamedSharding(mesh, P(None, 'y')))\n    self.assertArraysEqual(out, np.tile(np_inp, [8, 1]))",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_vmap_both_mapped(self):\n    mesh = jtu.create_mesh((2, 2), ('x', 'y'))\n    np_inp = np.arange(16).reshape(8, 2)\n    s = NamedSharding(mesh, P('x', 'y'))\n    inp1 = jax.device_put(np_inp, s)\n    np_inp2 = np.arange(16).reshape(2, 8)\n    inp2 = jax.device_put(np_inp2, NamedSharding(mesh, P('y', 'x')))\n\n    @jax.jit\n    def f(x, y):\n        return jax.vmap(shard_alike, in_axes=(0, 1))(x, y)\n    out1, out2 = f(inp1, inp2)\n    self.assertEqual(out1.sharding, s)\n    self.assertEqual(out2.sharding, s)\n    self.assertArraysEqual(out1, np_inp)\n    self.assertArraysEqual(out2, np_inp2.T)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef f(x, y):\n    return x * y"
  },
  {
    "test_code": "def test_shard_input_as_output(self):\n    mesh = jtu.create_mesh((4,), ('x',))\n    np_inp = np.arange(8.0)\n    s = NamedSharding(mesh, P('x'))\n\n    @jax.jit\n    def f(x):\n        y = jax.lax.with_sharding_constraint(x, s)\n        z = y * 2\n        return shard_alike(x, z)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        f(np_inp)\n        out1, out2 = f(np_inp)\n    self.assertEqual(count(), 1)\n    self.assertTrue(s.is_equivalent_to(out1.sharding, np_inp.ndim))\n    self.assertTrue(s.is_equivalent_to(out2.sharding, np_inp.ndim))\n\n    @jax.jit\n    def g(x):\n        z = x * 2\n        return shard_alike(x, z)\n    arr = jax.device_put(np_inp, s)\n    with jtu.count_pjit_cpp_cache_miss() as count:\n        g(arr)\n        out3, out4 = g(arr)\n    self.assertEqual(count(), 1)\n    self.assertEqual(out3.sharding, s)\n    self.assertEqual(out4.sharding, s)",
    "assertions": [],
    "test_file": "/var/folders/q5/p2sqhr0d6nqb_h8x_fxyxpz80000gn/T/tmp_1jzy6em/jax/tests/shard_alike_test.py",
    "function": "@jax.pmap\ndef g(z):\n    return f(z, z + 77)"
  }
]